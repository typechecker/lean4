<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>User Widgets - Lean Manual</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../alectryon.css">
        <link rel="stylesheet" href="../pygments.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme && theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar && sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../whatIsLean.html"><strong aria-hidden="true">1.</strong> What is Lean</a></li><li class="chapter-item "><a href="../tour.html"><strong aria-hidden="true">2.</strong> Tour of Lean</a></li><li class="chapter-item "><a href="../quickstart.html"><strong aria-hidden="true">3.</strong> Setting Up Lean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../setup.html"><strong aria-hidden="true">3.1.</strong> Extended Setup Notes</a></li></ol></li><li class="chapter-item "><a href="../tpil.html"><strong aria-hidden="true">4.</strong> Theorem Proving in Lean</a></li><li class="chapter-item "><a href="../fplean.html"><strong aria-hidden="true">5.</strong> Functional Programming in Lean</a></li><li class="chapter-item "><a href="../examples.html"><strong aria-hidden="true">6.</strong> Examples</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../examples/palindromes.lean.html"><strong aria-hidden="true">6.1.</strong> Palindromes</a></li><li class="chapter-item "><a href="../examples/bintree.lean.html"><strong aria-hidden="true">6.2.</strong> Binary Search Trees</a></li><li class="chapter-item "><a href="../examples/tc.lean.html"><strong aria-hidden="true">6.3.</strong> A Certified Type Checker</a></li><li class="chapter-item "><a href="../examples/interp.lean.html"><strong aria-hidden="true">6.4.</strong> The Well-Typed Interpreter</a></li><li class="chapter-item "><a href="../examples/deBruijn.lean.html"><strong aria-hidden="true">6.5.</strong> Dependent de Bruijn Indices</a></li><li class="chapter-item "><a href="../examples/phoas.lean.html"><strong aria-hidden="true">6.6.</strong> Parametric Higher-Order Abstract Syntax</a></li></ol></li><li class="chapter-item "><li class="part-title">Language Manual</li><li class="chapter-item "><a href="../organization.html"><strong aria-hidden="true">7.</strong> Organizational features</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sections.html"><strong aria-hidden="true">7.1.</strong> Sections</a></li><li class="chapter-item "><a href="../namespaces.html"><strong aria-hidden="true">7.2.</strong> Namespaces</a></li><li class="chapter-item "><a href="../implicit.html"><strong aria-hidden="true">7.3.</strong> Implicit Arguments</a></li><li class="chapter-item "><a href="../autobound.html"><strong aria-hidden="true">7.4.</strong> Auto Bound Implicit Arguments</a></li></ol></li><li class="chapter-item "><a href="../syntax.html"><strong aria-hidden="true">8.</strong> Syntax Extensions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../do.html"><strong aria-hidden="true">8.1.</strong> The do Notation</a></li><li class="chapter-item "><a href="../stringinterp.html"><strong aria-hidden="true">8.2.</strong> String Interpolation</a></li><li class="chapter-item "><a href="../notation.html"><strong aria-hidden="true">8.3.</strong> User-Defined Notation</a></li><li class="chapter-item "><a href="../macro_overview.html"><strong aria-hidden="true">8.4.</strong> Macro Overview</a></li><li class="chapter-item "><a href="../elaborators.html"><strong aria-hidden="true">8.5.</strong> Elaborators</a></li><li class="chapter-item "><a href="../syntax_examples.html"><strong aria-hidden="true">8.6.</strong> Examples</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../syntax_example.html"><strong aria-hidden="true">8.6.1.</strong> Balanced Parentheses</a></li><li class="chapter-item "><a href="../metaprogramming-arith.html"><strong aria-hidden="true">8.6.2.</strong> Arithmetic DSL</a></li></ol></li></ol></li><li class="chapter-item "><a href="../decltypes.html"><strong aria-hidden="true">9.</strong> Declaring New Types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../enum.html"><strong aria-hidden="true">9.1.</strong> Enumerated Types</a></li><li class="chapter-item "><a href="../inductive.html"><strong aria-hidden="true">9.2.</strong> Inductive Types</a></li><li class="chapter-item "><a href="../struct.html"><strong aria-hidden="true">9.3.</strong> Structures</a></li><li class="chapter-item "><a href="../typeclass.html"><strong aria-hidden="true">9.4.</strong> Type classes</a></li><li class="chapter-item "><a href="../unifhint.html"><strong aria-hidden="true">9.5.</strong> Unification Hints</a></li></ol></li><li class="chapter-item "><a href="../builtintypes.html"><strong aria-hidden="true">10.</strong> Builtin Types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../nat.html"><strong aria-hidden="true">10.1.</strong> Natural number</a></li><li class="chapter-item "><a href="../int.html"><strong aria-hidden="true">10.2.</strong> Integer</a></li><li class="chapter-item "><a href="../uint.html"><strong aria-hidden="true">10.3.</strong> Fixed precision unsigned integer</a></li><li class="chapter-item "><a href="../float.html"><strong aria-hidden="true">10.4.</strong> Float</a></li><li class="chapter-item "><a href="../array.html"><strong aria-hidden="true">10.5.</strong> Array</a></li><li class="chapter-item "><a href="../list.html"><strong aria-hidden="true">10.6.</strong> List</a></li><li class="chapter-item "><a href="../char.html"><strong aria-hidden="true">10.7.</strong> Character</a></li><li class="chapter-item "><a href="../string.html"><strong aria-hidden="true">10.8.</strong> String</a></li><li class="chapter-item "><a href="../option.html"><strong aria-hidden="true">10.9.</strong> Option</a></li><li class="chapter-item "><a href="../thunk.html"><strong aria-hidden="true">10.10.</strong> Thunk</a></li><li class="chapter-item "><a href="../task.html"><strong aria-hidden="true">10.11.</strong> Task and Thread</a></li></ol></li><li class="chapter-item "><a href="../functions.html"><strong aria-hidden="true">11.</strong> Functions</a></li><li class="chapter-item "><a href="../monads/intro.html"><strong aria-hidden="true">12.</strong> Monads</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../monads/functors.lean.html"><strong aria-hidden="true">12.1.</strong> Functor</a></li><li class="chapter-item "><a href="../monads/applicatives.lean.html"><strong aria-hidden="true">12.2.</strong> Applicative</a></li><li class="chapter-item "><a href="../monads/monads.lean.html"><strong aria-hidden="true">12.3.</strong> Monad</a></li><li class="chapter-item "><a href="../monads/readers.lean.html"><strong aria-hidden="true">12.4.</strong> Reader</a></li><li class="chapter-item "><a href="../monads/states.lean.html"><strong aria-hidden="true">12.5.</strong> State</a></li><li class="chapter-item "><a href="../monads/except.lean.html"><strong aria-hidden="true">12.6.</strong> Except</a></li><li class="chapter-item "><a href="../monads/transformers.lean.html"><strong aria-hidden="true">12.7.</strong> Transformers</a></li><li class="chapter-item "><a href="../monads/laws.lean.html"><strong aria-hidden="true">12.8.</strong> Laws</a></li></ol></li><li class="chapter-item "><li class="part-title">Other</li><li class="chapter-item "><a href="../faq.html"><strong aria-hidden="true">13.</strong> Frequently Asked Questions</a></li><li class="chapter-item "><a href="../lean3changes.html"><strong aria-hidden="true">14.</strong> Significant Changes from Lean 3</a></li><li class="chapter-item "><a href="../syntax_highlight_in_latex.html"><strong aria-hidden="true">15.</strong> Syntax Highlighting Lean in LaTeX</a></li><li class="chapter-item expanded "><a href="../examples/widgets.lean.html" class="active"><strong aria-hidden="true">16.</strong> User Widgets</a></li><li class="chapter-item "><a href="../semantic_highlighting.html"><strong aria-hidden="true">17.</strong> Semantic Highlighting</a></li><li class="chapter-item affix "><li class="part-title">Development</li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">18.</strong> Development Guide</a></li><li class="chapter-item "><a href="../make/index.html"><strong aria-hidden="true">19.</strong> Building Lean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../make/ubuntu.html"><strong aria-hidden="true">19.1.</strong> Ubuntu Setup</a></li><li class="chapter-item "><a href="../make/osx-10.9.html"><strong aria-hidden="true">19.2.</strong> macOS Setup</a></li><li class="chapter-item "><a href="../make/msys2.html"><strong aria-hidden="true">19.3.</strong> Windows MSYS2 Setup</a></li><li class="chapter-item "><a href="../make/wsl.html"><strong aria-hidden="true">19.4.</strong> Windows with WSL</a></li></ol></li><li class="chapter-item "><a href="../dev/bootstrap.html"><strong aria-hidden="true">20.</strong> Bootstrapping</a></li><li class="chapter-item "><a href="../dev/testing.html"><strong aria-hidden="true">21.</strong> Testing</a></li><li class="chapter-item "><a href="../dev/debugging.html"><strong aria-hidden="true">22.</strong> Debugging</a></li><li class="chapter-item "><a href="../dev/commit_convention.html"><strong aria-hidden="true">23.</strong> Commit Convention</a></li><li class="chapter-item "><a href="../dev/mdbook.html"><strong aria-hidden="true">24.</strong> Building This Manual</a></li><li class="chapter-item "><a href="../dev/ffi.html"><strong aria-hidden="true">25.</strong> Foreign Function Interface</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lean Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/leanprover/lean4" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">import</span> Lean
</span><span class="alectryon-token"><span class="kn">open</span></span><span class="alectryon-token"> Lean Widget</span></span></pre>
<h1 id="the-user-widgets-system"><a class="header" href="#the-user-widgets-system">The user-widgets system</a></h1>
<p>Proving and programming are inherently interactive tasks. Lots of mathematical objects and data
structures are visual in nature. <em>User widgets</em> let you associate custom interactive UIs with
sections of a Lean document. User widgets are rendered in the Lean infoview.</p>
<p><img src="../images/widgets_rubiks.png" alt="Rubik's cube" /></p>
<h2 id="trying-it-out"><a class="header" href="#trying-it-out">Trying it out</a></h2>
<p>To try it out, simply type in the following code and place your cursor over the <code>#widget</code> command.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">@[widget_module]</span>
</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>helloWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div><span class="nv">helloWidget</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Widget.Module</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Widget.Module</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  javascript := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>&quot;
    import * as React from 'react';
    export default function(props) {
      const name = props.name || 'world'
      return React.createElement('p', {}, name + '!')
    }&quot;</var><b>: </b><span>String</span></span></div></blockquote></div></small></div><span class="s2">&quot;</span>
<span class="s2">    import * as React from &#39;react&#39;;</span>
<span class="s2">    export default function(props) {</span>
<span class="s2">      const name = props.name || &#39;world&#39;</span>
<span class="s2">      return React.createElement(&#39;p&#39;, {}, name + &#39;!&#39;)</span>
<span class="s2">    }&quot;</span></span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="bp">#</span>widget</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>helloWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div>helloWidget</span><span class="alectryon-token"></span></span></pre>
<p>If you want to dive into a full sample right away, check out
<a href="https://github.com/leanprover/lean4-samples/blob/main/RubiksCube/"><code>RubiksCube</code></a>.
Below, we'll explain the system piece by piece.</p>
<p>⚠️ WARNING: All of the user widget APIs are <strong>unstable</strong> and subject to breaking changes.</p>
<h2 id="widget-sources-and-instances"><a class="header" href="#widget-sources-and-instances">Widget sources and instances</a></h2>
<p>A <em>widget source</em> is a valid JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">ESModule</a>
which exports a <a href="https://reactjs.org/docs/components-and-props.html">React component</a>. To access
React, the module must use <code>import * as React from 'react'</code>. Our first example of a widget source
is of course the value of <code>helloWidget.javascript</code>.</p>
<p>We can register a widget source with the <code>@[widget]</code> attribute, giving it a friendlier name
in the <code>name</code> field. This is bundled together in a <code>UserWidgetDefinition</code>.</p>
<p>A <em>widget instance</em> is then the identifier of a <code>UserWidgetDefinition</code> (so <code>`helloWidget</code>,
not <code>&quot;Hello&quot;</code>) associated with a range of positions in the Lean source code. Widget instances
are stored in the <em>infotree</em> in the same manner as other information about the source file
such as the type of every expression. In our example, the <code>#widget</code> command stores a widget instance
with the entire line as its range. We can think of a widget instance as an instruction for the
infoview: &quot;when the user places their cursor here, please render the following widget&quot;.</p>
<p>Every widget instance also contains a <code>props : Json</code> value. This value is passed as an argument
to the React component. In our first invocation of <code>#widget</code>, we set it to <code>.null</code>. Try out what
happens when you type in:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">structure</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>HelloWidgetProps</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>HelloWidgetProps</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name?</var><b>: </b><span>HelloWidgetProps → Option String</span></span></div></blockquote></div></small></div>name<span class="bp">?</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Option</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>Option</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>String</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>String</span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>none</var><b>: </b><span>{α : Type} → Option α</span></span></div></blockquote></div></small></div>none</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">deriving</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Server.RpcEncodable</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>Server.RpcEncodable</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="bp">#</span>widget</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>helloWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div>helloWidget</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">with</span></span><span class="alectryon-token"> { name<span class="bp">?</span> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>&quot;&lt;your name here&gt;&quot;</var><b>: </b><span>String</span></span></div></blockquote></div></small></div><span class="s2">&quot;&lt;your name here&gt;&quot;</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>HelloWidgetProps</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>HelloWidgetProps</span><span class="alectryon-token"> }</span></span></pre>
<p>💡 NOTE: The RPC system presented below does not depend on JavaScript. However the primary use case
is the web-based infoview in VSCode.</p>
<h2 id="querying-the-lean-server"><a class="header" href="#querying-the-lean-server">Querying the Lean server</a></h2>
<p>Besides enabling us to create cool client-side visualizations, user widgets come with the ability
to communicate with the Lean server. Thanks to this, they have the same metaprogramming capabilities
as custom elaborators or the tactic framework. To see this in action, let's implement a <code>#check</code>
command as a web input form. This example assumes some familiarity with React.</p>
<p>The first thing we'll need is to create an <em>RPC method</em>. Meaning &quot;Remote Procedure Call&quot;, this
is basically a Lean function callable from widget code (possibly remotely over the internet).
Our method will take in the <code>name : Name</code> of a constant in the environment and return its type.
By convention, we represent the input data as a <code>structure</code>. Since it will be sent over from JavaScript,
we need <code>FromJson</code> and <code>ToJson</code>. We'll see below why the position field is needed.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">structure</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GetTypeParams</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GetTypeParams</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  <span class="sd">/-- Name of a constant to get the type of. -/</span>
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name</var><b>: </b><span>GetTypeParams → Name</span></span></div></blockquote></div></small></div>name</span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Name</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Name</span><span class="alectryon-token">
  <span class="sd">/-- Position of our widget instance in the Lean file. -/</span>
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>pos</var><b>: </b><span>GetTypeParams → Lsp.Position</span></span></div></blockquote></div></small></div>pos</span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Lsp.Position</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Lsp.Position</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">deriving</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>FromJson</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>FromJson</span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>ToJson</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>ToJson</span><span class="alectryon-token"></span></span></pre>
<p>After its arguments, we define the <code>getType</code> method. Every RPC method executes in the <code>RequestM</code>
monad and must return a <code>RequestTask α</code> where <code>α</code> is its &quot;actual&quot; return type. The <code>Task</code> is so
that requests can be handled concurrently. A first guess for <code>α</code> might be <code>Expr</code>. However,
expressions in general can be large objects which depend on an <code>Environment</code> and <code>LocalContext</code>.
Thus we cannot directly serialize an <code>Expr</code> and send it to the widget. Instead, there are two
options:</p>
<ul>
<li>One is to send a <em>reference</em> which points to an object residing on the server. From JavaScript's
point of view, references are entirely opaque, but they can be sent back to other RPC methods for
further processing.</li>
<li>Two is to pretty-print the expression and send its textual representation called <code>CodeWithInfos</code>.
This representation contains extra data which the infoview uses for interactivity. We take this
strategy here.</li>
</ul>
<p>RPC methods execute in the context of a file, but not any particular <code>Environment</code> so they don't
know about the available <code>def</code>initions and <code>theorem</code>s. Thus, we need to pass in a position at which
we want to use the local <code>Environment</code>. This is why we store it in <code>GetTypeParams</code>. The <code>withWaitFindSnapAtPos</code>
method launches a concurrent computation whose job is to find such an <code>Environment</code> and a bit
more information for us, in the form of a <code>snap : Snapshot</code>. With this in hand, we can call
<code>MetaM</code> procedures to find out the type of <code>name</code> and pretty-print it.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">open</span></span><span class="alectryon-token"> Server RequestM </span><span class="alectryon-token"><span class="k">in</span></span><span class="alectryon-token">
<span class="kd">@[server_rpc_method]</span>
</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>getType</var><b>: </b><span>GetTypeParams → RequestM (RequestTask CodeWithInfos)</span></span></div></blockquote></div></small></div><span class="nv">getType</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>params</var><b>: </b><span>GetTypeParams</span></span></div></blockquote></div></small></div><span class="nv">params</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GetTypeParams</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GetTypeParams</span><span class="alectryon-token">) : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>RequestM</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>RequestM</span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>RequestTask</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>RequestTask</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>CodeWithInfos</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>CodeWithInfos</span><span class="alectryon-token">) :=
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>withWaitFindSnapAtPos</var><b>: </b><span>{α : Type} → Lsp.Position → (Snapshots.Snapshot → RequestM α) → RequestM (RequestTask α)</span></span></div></blockquote></div></small></div>withWaitFindSnapAtPos</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>params</var><b>: </b><span>GetTypeParams</span></span></div></blockquote></div></small></div><span class="nv">params</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>pos</var><b>: </b><span>GetTypeParams → Lsp.Position</span></span></div></blockquote></div></small></div>pos</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">fun</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>snap</var><b>: </b><span>Snapshots.Snapshot</span></span></div></blockquote></div></small></div><span class="nv">snap</span></span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
    </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>runTermElabM</var><b>: </b><span>{α : Type} → Snapshots.Snapshot → RequestT Elab.TermElabM α → RequestM α</span></span></div></blockquote></div></small></div>runTermElabM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>snap</var><b>: </b><span>Snapshots.Snapshot</span></span></div></blockquote></div></small></div><span class="nv">snap</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
      </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name</var><b>: </b><span>Name</span></span></div></blockquote></div></small></div><span class="nv">name</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>resolveGlobalConstNoOverloadCore</var><b>: </b><span>{m : Type → Type} →
  [inst : Monad m] → [inst : MonadResolveName m] → [inst : MonadEnv m] → [inst : MonadError m] → Name → m Name</span></span></div></blockquote></div></small></div>resolveGlobalConstNoOverloadCore</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>params</var><b>: </b><span>GetTypeParams</span></span></div></blockquote></div></small></div><span class="nv">params</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name</var><b>: </b><span>GetTypeParams → Name</span></span></div></blockquote></div></small></div>name</span><span class="alectryon-token">
      </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>c</var><b>: </b><span>ConstantInfo</span></span></div></blockquote></div></small></div><span class="nv">c</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><span class="k">try</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>getConstInfo</var><b>: </b><span>{m : Type → Type} → [inst : Monad m] → [inst : MonadEnv m] → [inst : MonadError m] → Name → m ConstantInfo</span></span></div></blockquote></div></small></div>getConstInfo</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name</var><b>: </b><span>Name</span></span></div></blockquote></div></small></div><span class="nv">name</span></span><span class="alectryon-token">
        </span><span class="alectryon-token"><span class="k">catch</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>_</var><b>: </b><span>Exception</span></span></div></blockquote></div></small></div>_</span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>throwThe</var><b>: </b><span>(ε : Type) → {m : Type → Type} → [inst : MonadExceptOf ε m] → {α : Type} → ε → m α</span></span></div></blockquote></div></small></div>throwThe</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>RequestError</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>RequestError</span><span class="alectryon-token"> ⟨</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>.invalidParams</var><b>: </b><span>JsonRpc.ErrorCode</span></span></div></blockquote></div></small></div><span class="bp">.</span>invalidParams</span><span class="alectryon-token">, </span><span class="alectryon-token">s<span class="bp">!</span></span><span class="alectryon-token"><span class="s2">&quot;no constant named &#39;{</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>name</var><b>: </b><span>Name</span></span></div></blockquote></div></small></div><span class="nv">name</span></span><span class="alectryon-token">}<span class="bp">&#39;</span><span class="s2">&quot;⟩</span>
      </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Widget.ppExprTagged</var><b>: </b><span>Expr → optParam Bool false → MetaM CodeWithInfos</span></span></div></blockquote></div></small></div>Widget.ppExprTagged</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>c</var><b>: </b><span>ConstantInfo</span></span></div></blockquote></div></small></div><span class="nv">c</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>type</var><b>: </b><span>ConstantInfo → Expr</span></span></div></blockquote></div></small></div>type</span><span class="alectryon-token"></span></span></pre>
<h2 id="using-infoview-components"><a class="header" href="#using-infoview-components">Using infoview components</a></h2>
<p>Now that we have all we need on the server side, let's write the widget source. By importing
<code>@leanprover/infoview</code>, widgets can render UI components used to implement the infoview itself.
For example, the <code>&lt;InteractiveCode&gt;</code> component displays expressions with <code>term : type</code> tooltips
as seen in the goal view. We will use it to implement our custom <code>#check</code> display.</p>
<p>⚠️ WARNING: Like the other widget APIs, the infoview JS API is <strong>unstable</strong> and subject to breaking changes.</p>
<p>The code below demonstrates useful parts of the API. To make RPC method calls, we use the <code>RpcContext</code>.
The <code>useAsync</code> helper packs the results of a call into an <code>AsyncState</code> structure which indicates
whether the call has resolved successfully, has returned an error, or is still in-flight. Based
on this we either display an <code>InteractiveCode</code> with the type, <code>mapRpcError</code> the error in order
to turn it into a readable message, or show a <code>Loading..</code> message, respectively.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">@[widget_module]</span>
</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>checkWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div><span class="nv">checkWidget</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Widget.Module</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Widget.Module</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  javascript := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>&quot;
import * as React from 'react';
const e = React.createElement;
import { RpcContext, InteractiveCode, useAsync, mapRpcError } from '@leanprover/infoview';

export default function(props) {
  const rs = React.useContext(RpcContext)
  const [name, setName] = React.useState('getType')

  const st = useAsync(() =&gt;
    rs.call('getType', { name, pos: props.pos }), [name, rs, props.pos])

  const type = st.state === 'resolved' ? st.value &amp;&amp; e(InteractiveCode, {fmt: st.value})
    : st.state === 'rejected' ? e('p', null, mapRpcError(st.error).message)
    : e('p', null, 'Loading..')
  const onChange = (event) =&gt; { setName(event.target.value) }
  return e('div', null,
    e('input', { value: name, onChange }), ' : ', type)
}
&quot;</var><b>: </b><span>String</span></span></div></blockquote></div></small></div><span class="s2">&quot;</span>
<span class="s2">import * as React from &#39;react&#39;;</span>
<span class="s2">const e = React.createElement;</span>
<span class="s2">import { RpcContext, InteractiveCode, useAsync, mapRpcError } from &#39;@leanprover/infoview&#39;;</span>

<span class="s2">export default function(props) {</span>
<span class="s2">  const rs = React.useContext(RpcContext)</span>
<span class="s2">  const [name, setName] = React.useState(&#39;getType&#39;)</span>

<span class="s2">  const st = useAsync(() =&gt;</span>
<span class="s2">    rs.call(&#39;getType&#39;, { name, pos: props.pos }), [name, rs, props.pos])</span>

<span class="s2">  const type = st.state === &#39;resolved&#39; ? st.value &amp;&amp; e(InteractiveCode, {fmt: st.value})</span>
<span class="s2">    : st.state === &#39;rejected&#39; ? e(&#39;p&#39;, null, mapRpcError(st.error).message)</span>
<span class="s2">    : e(&#39;p&#39;, null, &#39;Loading..&#39;)</span>
<span class="s2">  const onChange = (event) =&gt; { setName(event.target.value) }</span>
<span class="s2">  return e(&#39;div&#39;, null,</span>
<span class="s2">    e(&#39;input&#39;, { value: name, onChange }), &#39; : &#39;, type)</span>
<span class="s2">}</span>
<span class="s2">&quot;</span></span><span class="alectryon-token"></span></span></pre>
<p>Finally we can try out the widget.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="bp">#</span>widget</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>checkWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div>checkWidget</span><span class="alectryon-token"></span></span></pre>
<p><img src="../images/widgets_caas.png" alt="#check as a service" /></p>
<h2 id="building-widget-sources"><a class="header" href="#building-widget-sources">Building widget sources</a></h2>
<p>While typing JavaScript inline is fine for a simple example, for real developments we want to use
packages from NPM, a proper build system, and JSX. Thus, most actual widget sources are built with
Lake and NPM. They consist of multiple files and may import libraries which don't work as ESModules
by default. On the other hand a widget source must be a single, self-contained ESModule in the form
of a string. Readers familiar with web development may already have guessed that to obtain such a
string, we need a <em>bundler</em>. Two popular choices are <a href="https://rollupjs.org/guide/en/"><code>rollup.js</code></a>
and <a href="https://esbuild.github.io/"><code>esbuild</code></a>. If we go with <code>rollup.js</code>, to make a widget work with
the infoview we need to:</p>
<ul>
<li>Set <a href="https://rollupjs.org/guide/en/#outputformat"><code>output.format</code></a> to <code>'es'</code>.</li>
<li><a href="https://rollupjs.org/guide/en/#external">Externalize</a> <code>react</code>, <code>react-dom</code>, <code>@leanprover/infoview</code>.
These libraries are already loaded by the infoview so they should not be bundled.</li>
</ul>
<p>In the RubiksCube sample, we provide a working <code>rollup.js</code> build configuration in
<a href="https://github.com/leanprover/lean4-samples/blob/main/RubiksCube/widget/rollup.config.js">rollup.config.js</a>.</p>
<h2 id="inserting-text"><a class="header" href="#inserting-text">Inserting text</a></h2>
<p>We can also instruct the editor to insert text, copy text to the clipboard, or
reveal a certain location in the document.
To do this, use the <code>React.useContext(EditorContext)</code> React context.
This will return an <code>EditorConnection</code> whose <code>api</code> field contains a number of methods to
interact with the text editor.</p>
<p>You can see the full API for this <a href="https://github.com/leanprover/vscode-lean4/blob/master/lean4-infoview-api/src/infoviewApi.ts#L52">here</a></p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">@[widget_module]</span>
</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>insertTextWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div><span class="nv">insertTextWidget</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Widget.Module</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Widget.Module</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  javascript := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>&quot;
import * as React from 'react';
const e = React.createElement;
import { EditorContext } from '@leanprover/infoview';

export default function(props) {
  const editorConnection = React.useContext(EditorContext)
  function onClick() {
    editorConnection.api.insertText('-- hello!!!', 'above')
  }

  return e('div', null, e('button', { value: name, onClick }, 'insert'))
}
&quot;</var><b>: </b><span>String</span></span></div></blockquote></div></small></div><span class="s2">&quot;</span>
<span class="s2">import * as React from &#39;react&#39;;</span>
<span class="s2">const e = React.createElement;</span>
<span class="s2">import { EditorContext } from &#39;@leanprover/infoview&#39;;</span>

<span class="s2">export default function(props) {</span>
<span class="s2">  const editorConnection = React.useContext(EditorContext)</span>
<span class="s2">  function onClick() {</span>
<span class="s2">    editorConnection.api.insertText(&#39;-- hello!!!&#39;, &#39;above&#39;)</span>
<span class="s2">  }</span>

<span class="s2">  return e(&#39;div&#39;, null, e(&#39;button&#39;, { value: name, onClick }, &#39;insert&#39;))</span>
<span class="s2">}</span>
<span class="s2">&quot;</span></span><span class="alectryon-token"></span></span></pre>
<p>Finally, we can try this out:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="bp">#</span>widget</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>insertTextWidget</var><b>: </b><span>Widget.Module</span></span></div></blockquote></div></small></div>insertTextWidget</span><span class="alectryon-token"></span></span></pre>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../syntax_highlight_in_latex.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../semantic_highlighting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../syntax_highlight_in_latex.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../semantic_highlighting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../alectryon.js"></script>
    </body>
</html>
