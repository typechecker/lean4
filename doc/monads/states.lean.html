<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State - Lean Manual</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../alectryon.css">
        <link rel="stylesheet" href="../pygments.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme && theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar && sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../whatIsLean.html"><strong aria-hidden="true">1.</strong> What is Lean</a></li><li class="chapter-item "><a href="../tour.html"><strong aria-hidden="true">2.</strong> Tour of Lean</a></li><li class="chapter-item "><a href="../quickstart.html"><strong aria-hidden="true">3.</strong> Setting Up Lean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../setup.html"><strong aria-hidden="true">3.1.</strong> Extended Setup Notes</a></li></ol></li><li class="chapter-item "><a href="../tpil.html"><strong aria-hidden="true">4.</strong> Theorem Proving in Lean</a></li><li class="chapter-item "><a href="../fplean.html"><strong aria-hidden="true">5.</strong> Functional Programming in Lean</a></li><li class="chapter-item "><a href="../examples.html"><strong aria-hidden="true">6.</strong> Examples</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../examples/palindromes.lean.html"><strong aria-hidden="true">6.1.</strong> Palindromes</a></li><li class="chapter-item "><a href="../examples/bintree.lean.html"><strong aria-hidden="true">6.2.</strong> Binary Search Trees</a></li><li class="chapter-item "><a href="../examples/tc.lean.html"><strong aria-hidden="true">6.3.</strong> A Certified Type Checker</a></li><li class="chapter-item "><a href="../examples/interp.lean.html"><strong aria-hidden="true">6.4.</strong> The Well-Typed Interpreter</a></li><li class="chapter-item "><a href="../examples/deBruijn.lean.html"><strong aria-hidden="true">6.5.</strong> Dependent de Bruijn Indices</a></li><li class="chapter-item "><a href="../examples/phoas.lean.html"><strong aria-hidden="true">6.6.</strong> Parametric Higher-Order Abstract Syntax</a></li></ol></li><li class="chapter-item "><li class="part-title">Language Manual</li><li class="chapter-item "><a href="../organization.html"><strong aria-hidden="true">7.</strong> Organizational features</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sections.html"><strong aria-hidden="true">7.1.</strong> Sections</a></li><li class="chapter-item "><a href="../namespaces.html"><strong aria-hidden="true">7.2.</strong> Namespaces</a></li><li class="chapter-item "><a href="../implicit.html"><strong aria-hidden="true">7.3.</strong> Implicit Arguments</a></li><li class="chapter-item "><a href="../autobound.html"><strong aria-hidden="true">7.4.</strong> Auto Bound Implicit Arguments</a></li></ol></li><li class="chapter-item "><a href="../syntax.html"><strong aria-hidden="true">8.</strong> Syntax Extensions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../do.html"><strong aria-hidden="true">8.1.</strong> The do Notation</a></li><li class="chapter-item "><a href="../stringinterp.html"><strong aria-hidden="true">8.2.</strong> String Interpolation</a></li><li class="chapter-item "><a href="../notation.html"><strong aria-hidden="true">8.3.</strong> User-Defined Notation</a></li><li class="chapter-item "><a href="../macro_overview.html"><strong aria-hidden="true">8.4.</strong> Macro Overview</a></li><li class="chapter-item "><a href="../elaborators.html"><strong aria-hidden="true">8.5.</strong> Elaborators</a></li><li class="chapter-item "><a href="../syntax_examples.html"><strong aria-hidden="true">8.6.</strong> Examples</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../syntax_example.html"><strong aria-hidden="true">8.6.1.</strong> Balanced Parentheses</a></li><li class="chapter-item "><a href="../metaprogramming-arith.html"><strong aria-hidden="true">8.6.2.</strong> Arithmetic DSL</a></li></ol></li></ol></li><li class="chapter-item "><a href="../decltypes.html"><strong aria-hidden="true">9.</strong> Declaring New Types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../enum.html"><strong aria-hidden="true">9.1.</strong> Enumerated Types</a></li><li class="chapter-item "><a href="../inductive.html"><strong aria-hidden="true">9.2.</strong> Inductive Types</a></li><li class="chapter-item "><a href="../struct.html"><strong aria-hidden="true">9.3.</strong> Structures</a></li><li class="chapter-item "><a href="../typeclass.html"><strong aria-hidden="true">9.4.</strong> Type classes</a></li><li class="chapter-item "><a href="../unifhint.html"><strong aria-hidden="true">9.5.</strong> Unification Hints</a></li></ol></li><li class="chapter-item "><a href="../builtintypes.html"><strong aria-hidden="true">10.</strong> Builtin Types</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../nat.html"><strong aria-hidden="true">10.1.</strong> Natural number</a></li><li class="chapter-item "><a href="../int.html"><strong aria-hidden="true">10.2.</strong> Integer</a></li><li class="chapter-item "><a href="../uint.html"><strong aria-hidden="true">10.3.</strong> Fixed precision unsigned integer</a></li><li class="chapter-item "><a href="../float.html"><strong aria-hidden="true">10.4.</strong> Float</a></li><li class="chapter-item "><a href="../array.html"><strong aria-hidden="true">10.5.</strong> Array</a></li><li class="chapter-item "><a href="../list.html"><strong aria-hidden="true">10.6.</strong> List</a></li><li class="chapter-item "><a href="../char.html"><strong aria-hidden="true">10.7.</strong> Character</a></li><li class="chapter-item "><a href="../string.html"><strong aria-hidden="true">10.8.</strong> String</a></li><li class="chapter-item "><a href="../option.html"><strong aria-hidden="true">10.9.</strong> Option</a></li><li class="chapter-item "><a href="../thunk.html"><strong aria-hidden="true">10.10.</strong> Thunk</a></li><li class="chapter-item "><a href="../task.html"><strong aria-hidden="true">10.11.</strong> Task and Thread</a></li></ol></li><li class="chapter-item "><a href="../functions.html"><strong aria-hidden="true">11.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../monads/intro.html"><strong aria-hidden="true">12.</strong> Monads</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../monads/functors.lean.html"><strong aria-hidden="true">12.1.</strong> Functor</a></li><li class="chapter-item "><a href="../monads/applicatives.lean.html"><strong aria-hidden="true">12.2.</strong> Applicative</a></li><li class="chapter-item "><a href="../monads/monads.lean.html"><strong aria-hidden="true">12.3.</strong> Monad</a></li><li class="chapter-item "><a href="../monads/readers.lean.html"><strong aria-hidden="true">12.4.</strong> Reader</a></li><li class="chapter-item expanded "><a href="../monads/states.lean.html" class="active"><strong aria-hidden="true">12.5.</strong> State</a></li><li class="chapter-item "><a href="../monads/except.lean.html"><strong aria-hidden="true">12.6.</strong> Except</a></li><li class="chapter-item "><a href="../monads/transformers.lean.html"><strong aria-hidden="true">12.7.</strong> Transformers</a></li><li class="chapter-item "><a href="../monads/laws.lean.html"><strong aria-hidden="true">12.8.</strong> Laws</a></li></ol></li><li class="chapter-item "><li class="part-title">Other</li><li class="chapter-item "><a href="../faq.html"><strong aria-hidden="true">13.</strong> Frequently Asked Questions</a></li><li class="chapter-item "><a href="../lean3changes.html"><strong aria-hidden="true">14.</strong> Significant Changes from Lean 3</a></li><li class="chapter-item "><a href="../syntax_highlight_in_latex.html"><strong aria-hidden="true">15.</strong> Syntax Highlighting Lean in LaTeX</a></li><li class="chapter-item "><a href="../examples/widgets.lean.html"><strong aria-hidden="true">16.</strong> User Widgets</a></li><li class="chapter-item "><a href="../semantic_highlighting.html"><strong aria-hidden="true">17.</strong> Semantic Highlighting</a></li><li class="chapter-item affix "><li class="part-title">Development</li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">18.</strong> Development Guide</a></li><li class="chapter-item "><a href="../make/index.html"><strong aria-hidden="true">19.</strong> Building Lean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../make/ubuntu.html"><strong aria-hidden="true">19.1.</strong> Ubuntu Setup</a></li><li class="chapter-item "><a href="../make/osx-10.9.html"><strong aria-hidden="true">19.2.</strong> macOS Setup</a></li><li class="chapter-item "><a href="../make/msys2.html"><strong aria-hidden="true">19.3.</strong> Windows MSYS2 Setup</a></li><li class="chapter-item "><a href="../make/wsl.html"><strong aria-hidden="true">19.4.</strong> Windows with WSL</a></li></ol></li><li class="chapter-item "><a href="../dev/bootstrap.html"><strong aria-hidden="true">20.</strong> Bootstrapping</a></li><li class="chapter-item "><a href="../dev/testing.html"><strong aria-hidden="true">21.</strong> Testing</a></li><li class="chapter-item "><a href="../dev/debugging.html"><strong aria-hidden="true">22.</strong> Debugging</a></li><li class="chapter-item "><a href="../dev/commit_convention.html"><strong aria-hidden="true">23.</strong> Commit Convention</a></li><li class="chapter-item "><a href="../dev/mdbook.html"><strong aria-hidden="true">24.</strong> Building This Manual</a></li><li class="chapter-item "><a href="../dev/ffi.html"><strong aria-hidden="true">25.</strong> Foreign Function Interface</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lean Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/leanprover/lean4" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">import</span> Lean.Data.HashMap</span></span></pre>
<h1 id="state"><a class="header" href="#state">State</a></h1>
<p>In the <a href="readers.lean.html">previous section</a>, you learned about the <code>ReaderM</code> monad. Hopefully this gave you
a new perspective on Lean. It showed that, in fact, you <em>can</em> have global variables of some sort;
you just need to encode them in the type signature somehow, and this is what monads are for! In this
part, you will explore the <code>StateM</code> monad, which is like a <code>ReaderM</code> only the state can also be updated.</p>
<h2 id="motivating-example-tic-tac-toe"><a class="header" href="#motivating-example-tic-tac-toe">Motivating example: Tic Tac Toe</a></h2>
<p>For this section, let's build a simple model for a Tic Tace Toe game. The main object is the <code>GameState</code>
data type containing several important pieces of information. First and foremost, it has the
&quot;board&quot;, a map from 2D tile indices to the &quot;Tile State&quot; (X, O or empty). Then it also knows the
current player, and it has a random generator.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">open</span></span><span class="alectryon-token"> Std (</span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk0" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk0"><span class="alectryon-token">HashMap</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: unknown <span class="kd">constant</span> <span class="bp">&#39;</span>Std.HashMap&#39;</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">)
</span><span class="alectryon-token"><span class="k">abbrev</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileIndex</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div><span class="nv">TileIndex</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Nat</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Nat</span><span class="alectryon-token"> <span class="bp">×</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Nat</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Nat</span><span class="alectryon-token"> <span class="c1">-- a 2D index</span>

</span><span class="alectryon-token"><span class="kd">inductive</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div><span class="nv">TileState</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  <span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileEmpty</var><b>: </b><span>TileState</span></span></div></blockquote></div></small></div>TileEmpty</span><span class="alectryon-token"> <span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileX</var><b>: </b><span>TileState</span></span></div></blockquote></div></small></div>TileX</span><span class="alectryon-token"> <span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileO</var><b>: </b><span>TileState</span></span></div></blockquote></div></small></div>TileO</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">deriving</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Repr</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>Repr</span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>BEq</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>BEq</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">inductive</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Player</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div><span class="nv">Player</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  <span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>XPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>XPlayer</span><span class="alectryon-token"> <span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>OPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>OPlayer</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">deriving</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Repr</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>Repr</span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>BEq</var><b>: </b><span>Type u → Type u</span></span></div></blockquote></div></small></div>BEq</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="k">abbrev</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Board</var><b>: </b><span>?m.657</span></span></div></blockquote></div></small></div><span class="nv">Board</span></span><span class="alectryon-token"> := </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk1" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk1"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>HashMap</var><b>: </b><span>?m.657</span></span></div></blockquote></div></small></div>HashMap</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: unknown identifier <span class="bp">&#39;</span>HashMap&#39;</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var> TileIndex TileState</var><b>: </b><span>?m.657</span></span></div></blockquote></div></small></div> TileIndex TileState</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">structure</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type u_1</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">where</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>GameState → {Board : Sort u_1} → Board</span></span></div></blockquote></div></small></div>board</span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Board</var><b>: </b><span>Sort u_1</span></span></div></blockquote></div></small></div><span class="nv">Board</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>currentPlayer</var><b>: </b><span>GameState → Player</span></span></div></blockquote></div></small></div>currentPlayer</span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Player</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Player</span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>generator</var><b>: </b><span>GameState → StdGen</span></span></div></blockquote></div></small></div>generator</span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StdGen</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>StdGen</span><span class="alectryon-token"></span></span></pre>
<p>Let's think at a high level about how some of the game functions would work. You could, for
instance, have a function for selecting a random move. This would output a <code>TileIndex</code> to play and
alter the game's number generator. You would then make a move based on the selected move and the
current player. This would change the board state as well as swap the current player. In other
words, you have operations that depend on the current state of the game, but also need to <strong>update
that state</strong>.</p>
<h2 id="the-statem-monad-to-the-rescue"><a class="header" href="#the-statem-monad-to-the-rescue">The StateM Monad to the Rescue</a></h2>
<p>This is exactly the situation the <code>StateM</code> monad deals with. The <code>StateM</code> monad wraps computations in
the context of reading and modifying a global state object.</p>
<p>It is parameterized by a single type parameter <code>s</code>, the state type in use. So just like the <code>ReaderM</code>
has a single type you read from, the <code>StateM</code> has a single type you can both <strong>read from and write
to</strong>. There are three primary actions you can take within the <code>StateM</code>monad:</p>
<ul>
<li><strong>get</strong> - retrieves the state, like Reader.read</li>
<li><strong>set</strong> - updates the state</li>
<li><strong>modifyGet</strong> - retrieves the state, then updates it</li>
</ul>
<p>There is also a <code>run</code> function, similar to <code>run</code> on <code>ReaderM</code>. Like the <code>ReaderM</code> monad, you must
provide an initial state, in addition to the computation to run. <code>StateM</code> then produces two outputs:
the result of the computation combined with the final updated state.</p>
<p>If you wish to discard the final state and just get the computation's result, you can use
<code>run'</code> method instead.  Yes in Lean, the apostrophe can be part of a name, you read this &quot;run
prime&quot;, and the general naming convention is that the prime method discards something.</p>
<p>So for your Tic Tac Toe game, many of your functions will have a signature like <code>State GameState a</code>.</p>
<h2 id="stateful-functions"><a class="header" href="#stateful-functions">Stateful Functions</a></h2>
<p>Now you can examine some of the different functions mentioned above and determine their types.
You can, for instance, pick a random move:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">open</span></span><span class="alectryon-token"> TileState

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>findOpen</var><b>: </b><span>StateM GameState (List TileIndex)</span></span></div></blockquote></div></small></div><span class="nv">findOpen</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StateM</var><b>: </b><span>Type → Type → Type</span></span></div></blockquote></div></small></div>StateM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>List</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>List</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileIndex</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>TileIndex</span><span class="alectryon-token">) := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>get</var><b>: </b><span>{σ : outParam Type} → {m : Type → Type} → [self : MonadState σ m] → m σ</span></span></div></blockquote></div></small></div>get</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">return</span></span><span class="alectryon-token"> </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk2" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk2"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>GameState → ∀ {Board : Prop}, Board</span></span></div></blockquote></div></small></div>board</span><span class="alectryon-token"><span class="bp">.</span>toList.filterMap </span><span class="alectryon-token"><span class="k">fun</span></span><span class="alectryon-token"> (i, x) <span class="bp">=&gt;</span> guard (x <span class="bp">==</span> TileEmpty) <span class="bp">*&gt;</span> pure i</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: invalid field <span class="kd">notation</span>, type is not of the form (C <span class="bp">...</span>) where C is a <span class="kd">constant</span>
  game.board
has type
  <span class="bp">?</span>m.1336</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>chooseRandomMove</var><b>: </b><span>StateM GameState TileIndex</span></span></div></blockquote></div></small></div><span class="nv">chooseRandomMove</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StateM</var><b>: </b><span>Type → Type → Type</span></span></div></blockquote></div></small></div>StateM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileIndex</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>TileIndex</span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>get</var><b>: </b><span>{σ : outParam Type} → {m : Type → Type} → [self : MonadState σ m] → m σ</span></span></div></blockquote></div></small></div>get</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>openSpots</var><b>: </b><span>List TileIndex</span></span></div></blockquote></div></small></div><span class="nv">openSpots</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>findOpen</var><b>: </b><span>StateM GameState (List TileIndex)</span></span></div></blockquote></div></small></div>findOpen</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>generator</var><b>: </b><span>GameState → StdGen</span></span></div></blockquote></div></small></div>generator</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen'</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen&#39;</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>randNat</var><b>: </b><span>{gen : Type} → [inst : RandomGen gen] → gen → Nat → Nat → Nat × gen</span></span></div></blockquote></div></small></div>randNat</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>0</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">0</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>openSpots</var><b>: </b><span>List TileIndex</span></span></div></blockquote></div></small></div><span class="nv">openSpots</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>length</var><b>: </b><span>{α : Type} → List α → Nat</span></span></div></blockquote></div></small></div>length</span><span class="alectryon-token"> <span class="bp">-</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>1</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">1</span></span><span class="alectryon-token">)
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>set</var><b>: </b><span>{σ : semiOutParam Type} → {m : Type → Type} → [self : MonadStateOf σ m] → σ → m PUnit</span></span></div></blockquote></div></small></div>set</span><span class="alectryon-token"> { </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">with</span></span><span class="alectryon-token"> generator := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen'</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen&#39;</span></span><span class="alectryon-token"> }
  </span><span class="alectryon-token"><span class="k">return</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>openSpots</var><b>: </b><span>List TileIndex</span></span></div></blockquote></div></small></div><span class="nv">openSpots</span></span><span class="alectryon-token">[</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">]<span class="bp">!</span></span></span></pre>
<p>This returns a <code>TileIndex</code> and modifies the random number generator stored in the <code>GameState</code>!
Notice you have a fun little use of the <code>Applicative.seqRight</code> operator <code>*&gt;</code> in <code>findOpen</code>
as described in <a href="applicatives.lean.html">Applicatives</a>.</p>
<p>Now you can create the function that can make a move:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kn">open</span></span><span class="alectryon-token"> Player

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>tileStateForPlayer</var><b>: </b><span>Player → TileState</span></span></div></blockquote></div></small></div><span class="nv">tileStateForPlayer</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Player</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Player</span><span class="alectryon-token"> <span class="bp">→</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>TileState</span><span class="alectryon-token">
<span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>XPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>XPlayer</span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileX</var><b>: </b><span>TileState</span></span></div></blockquote></div></small></div>TileX</span><span class="alectryon-token">
<span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>OPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>OPlayer</span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileO</var><b>: </b><span>TileState</span></span></div></blockquote></div></small></div>TileO</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>nextPlayer</var><b>: </b><span>Player → Player</span></span></div></blockquote></div></small></div><span class="nv">nextPlayer</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Player</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Player</span><span class="alectryon-token"> <span class="bp">→</span>  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Player</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Player</span><span class="alectryon-token">
<span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>XPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>XPlayer</span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>OPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>OPlayer</span><span class="alectryon-token">
<span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>OPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>OPlayer</span><span class="alectryon-token"> <span class="bp">=&gt;</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>XPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>XPlayer</span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>applyMove</var><b>: </b><span>TileIndex → StateM GameState Unit</span></span></div></blockquote></div></small></div><span class="nv">applyMove</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileIndex</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>TileIndex</span><span class="alectryon-token">): </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StateM</var><b>: </b><span>Type → Type → Type</span></span></div></blockquote></div></small></div>StateM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Unit</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Unit</span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>get</var><b>: </b><span>{σ : outParam Type} → {m : Type → Type} → [self : MonadState σ m] → m σ</span></span></div></blockquote></div></small></div>get</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>p</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div><span class="nv">p</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>currentPlayer</var><b>: </b><span>GameState → Player</span></span></div></blockquote></div></small></div>currentPlayer</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>newBoard</var><b>: </b><span>∀ {Board : Prop}, Board</span></span></div></blockquote></div></small></div><span class="nv">newBoard</span></span><span class="alectryon-token"> := </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk3" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk3"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>GameState → ∀ {Board : Prop}, Board</span></span></div></blockquote></div></small></div>board</span><span class="alectryon-token"><span class="bp">.</span>insert i (tileStateForPlayer p)</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: invalid field <span class="kd">notation</span>, type is not of the form (C <span class="bp">...</span>) where C is a <span class="kd">constant</span>
  game.board
has type
  <span class="bp">?</span>m.2455</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>set</var><b>: </b><span>{σ : semiOutParam Type} → {m : Type → Type} → [self : MonadStateOf σ m] → σ → m PUnit</span></span></div></blockquote></div></small></div>set</span><span class="alectryon-token"> { </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>game</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">game</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">with</span></span><span class="alectryon-token"> currentPlayer := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>nextPlayer</var><b>: </b><span>Player → Player</span></span></div></blockquote></div></small></div>nextPlayer</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>p</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div><span class="nv">p</span></span><span class="alectryon-token">, board := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>newBoard</var><b>: </b><span>∀ {Board : Prop}, Board</span></span></div></blockquote></div></small></div><span class="nv">newBoard</span></span><span class="alectryon-token"> }</span></span></pre>
<p>This updates the board in the <code>GameState</code> with the new tile, and then changes the current player,
providing no output (<code>Unit</code> return type).</p>
<p>So finally, you can combine these functions together with <code>do</code> notation, and it actually looks quite
clean! You don't need to worry about the side effects. The different monadic functions handle them.
Here's a sample of what your function might look like to play one turn of the game. At the end, it
returns a boolean determining if all the spaces have been filled.</p>
<p>Notice in <code>isGameDone</code> and <code>nextTurn</code> we have stopped providing the full return type
<code>StateM GameState Unit</code>.  This is because Lean is able to infer the correct monadic return type
from the context and as a result the code is now looking really clean.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>isGameDone</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div><span class="nv">isGameDone</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">return</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>(← findOpen)</var><b>: </b><span>List TileIndex</span></span></div></blockquote></div></small></div>(<span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>findOpen</var><b>: </b><span>StateM GameState (List TileIndex)</span></span></div></blockquote></div></small></div><span class="nv">findOpen</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>(← findOpen)</var><b>: </b><span>List TileIndex</span></span></div></blockquote></div></small></div>)</span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>isEmpty</var><b>: </b><span>{α : Type} → List α → Bool</span></span></div></blockquote></div></small></div><span class="na">isEmpty</span></span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>nextTurn</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div><span class="nv">nextTurn</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>chooseRandomMove</var><b>: </b><span>StateM GameState TileIndex</span></span></div></blockquote></div></small></div>chooseRandomMove</span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>applyMove</var><b>: </b><span>TileIndex → StateM GameState Unit</span></span></div></blockquote></div></small></div>applyMove</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>isGameDone</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div>isGameDone</span><span class="alectryon-token"></span></span></pre>
<p>To give you a quick test harness that runs all moves for both players you can run this:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>initBoard</var><b>: </b><span>{Board : Type u_1} → Board</span></span></div></blockquote></div></small></div><span class="nv">initBoard</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Board</var><b>: </b><span>Type u_1</span></span></div></blockquote></div></small></div><span class="nv">Board</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Id.run</var><b>: </b><span>{α : Type u_1} → Id α → α</span></span></div></blockquote></div></small></div>Id.run</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">mut</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Id Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token"> := </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk4" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk4"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>HashMap.empty</var><b>: </b><span>Id Board</span></span></div></blockquote></div></small></div>HashMap.empty</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: unknown identifier <span class="bp">&#39;</span>HashMap.empty&#39;</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">for</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">in</span></span><span class="alectryon-token"> [</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>0</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">0</span></span><span class="alectryon-token">:</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>3</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">3</span></span><span class="alectryon-token">] </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
    </span><span class="alectryon-token"><span class="k">for</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>j</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">j</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">in</span></span><span class="alectryon-token"> [</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>0</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">0</span></span><span class="alectryon-token">:</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>3</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">3</span></span><span class="alectryon-token">] </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
      </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>t</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">t</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>TileIndex</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>TileIndex</span><span class="alectryon-token"> := (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>j</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">j</span></span><span class="alectryon-token">)
      </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Id Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token"> := </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk5" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk5"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Id Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token"><span class="bp">.</span>insert t TileEmpty</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: invalid field <span class="kd">notation</span>, type is not of the form (C <span class="bp">...</span>) where C is a <span class="kd">constant</span>
  board
has type
  Board</blockquote><blockquote class="alectryon-message">Error: invalid field <span class="bp">&#39;</span>insert&#39;, the environment does not contain <span class="bp">&#39;</span>Id.insert&#39;
  board
has type
  Id Board</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Id Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>printBoard</var><b>: </b><span>{Board : Sort u_1} → Board → IO Unit</span></span></div></blockquote></div></small></div><span class="nv">printBoard</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Board</var><b>: </b><span>Sort u_1</span></span></div></blockquote></div></small></div><span class="nv">Board</span></span><span class="alectryon-token">) : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>IO</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>IO</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Unit</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Unit</span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">mut</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>row</var><b>: </b><span>List String</span></span></div></blockquote></div></small></div><span class="nv">row</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>List</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>List</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>String</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>String</span><span class="alectryon-token"> := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>[]</var><b>: </b><span>List String</span></span></div></blockquote></div></small></div>[]</span><span class="alectryon-token">
  </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk6" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk6"><span class="alectryon-token"><span class="k">for</span></span><span class="alectryon-token"> i </span><span class="alectryon-token"><span class="k">in</span></span><span class="alectryon-token"></span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: failed to construct <span class="bp">&#39;</span>ForIn&#39; <span class="kd">instance</span> for collection
  <span class="bp">?</span>m.3568 board
and monad
  EIO IO.Error</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token"> </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk7" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk7"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>Board</span></span></div></blockquote></div></small></div><span class="nv">board</span></span><span class="alectryon-token"><span class="bp">.</span>toList</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: failed to construct <span class="bp">&#39;</span>ForIn&#39; <span class="kd">instance</span> for collection
  <span class="bp">?</span>m.3568 board
and monad
  EIO IO.Error</blockquote><blockquote class="alectryon-message">Error: invalid field <span class="kd">notation</span>, type is not of the form (C <span class="bp">...</span>) where C is a <span class="kd">constant</span>
  board
has type
  Board</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token"> </span><span class="alectryon-token"></span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk8" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk8"><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
    </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> s := </span><span class="alectryon-token"><span class="k">match</span></span><span class="alectryon-token"> i.2 </span><span class="alectryon-token"><span class="k">with</span></span><span class="alectryon-token">
      <span class="bp">|</span> TileEmpty <span class="bp">=&gt;</span> <span class="s2">&quot; &quot;</span>
      <span class="bp">|</span> TileX <span class="bp">=&gt;</span> <span class="s2">&quot;X&quot;</span>
      <span class="bp">|</span> TileO <span class="bp">=&gt;</span> <span class="s2">&quot;O&quot;</span>
    row := row.append [s]
    </span><span class="alectryon-token"><span class="k">if</span></span><span class="alectryon-token"> row.length <span class="bp">==</span> <span class="mi">3</span> </span><span class="alectryon-token"><span class="k">then</span></span><span class="alectryon-token">
      IO.println row
      row := []</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: failed to construct <span class="bp">&#39;</span>ForIn&#39; <span class="kd">instance</span> for collection
  <span class="bp">?</span>m.3568 board
and monad
  EIO IO.Error</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>playGame</var><b>: </b><span>StateM GameState PUnit</span></span></div></blockquote></div></small></div><span class="nv">playGame</span></span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">while</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>true</var><b>: </b><span>Bool</span></span></div></blockquote></div></small></div>true</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
    </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>finished</var><b>: </b><span>Bool</span></span></div></blockquote></div></small></div><span class="nv">finished</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>nextTurn</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div>nextTurn</span><span class="alectryon-token">
    </span><span class="alectryon-token"><span class="k">if</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>finished</var><b>: </b><span>Bool</span></span></div></blockquote></div></small></div><span class="nv">finished</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">then</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>return</var><b>: </b><span>StateM GameState (ForInStep (MProd (Option PUnit) PUnit))</span></span></div></blockquote></div></small></div><span class="k">return</span></span><span class="alectryon-token">

</span><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>main</var><b>: </b><span>IO Unit</span></span></div></blockquote></div></small></div><span class="nv">main</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>IO</var><b>: </b><span>Type → Type</span></span></div></blockquote></div></small></div>IO</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Unit</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Unit</span><span class="alectryon-token"> := </span><span class="alectryon-token"><span class="k">do</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen</span></span><span class="alectryon-token"> <span class="bp">←</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>IO.stdGenRef</var><b>: </b><span>IO.Ref StdGen</span></span></div></blockquote></div></small></div>IO.stdGenRef</span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>get</var><b>: </b><span>{σ : Type} → {m : Type → Type} → [inst : MonadLiftT (ST σ) m] → {α : Type} → ST.Ref σ α → m α</span></span></div></blockquote></div></small></div>get</span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>x</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">x</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen'</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen&#39;</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>randNat</var><b>: </b><span>{gen : Type} → [inst : RandomGen gen] → gen → Nat → Nat → Nat × gen</span></span></div></blockquote></div></small></div>randNat</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>0</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">0</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>1</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">1</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs</span></span><span class="alectryon-token"> := {
    board := </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chk9" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chk9"><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>initBoard</var><b>: </b><span>{Board : Type ?u.4695} → Board</span></span></div></blockquote></div></small></div>initBoard</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: type mismatch
  initBoard
has type
  <span class="bp">?</span>m.4696 : <span class="kt">Type</span> <span class="bp">?</span>u.4695
but is expected to <span class="k">have</span> type
  Board<span class="bp">✝</span> : <span class="kt">Prop</span></blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">,
    currentPlayer := </span><span class="alectryon-token"><span class="k">if</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>x</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="nv">x</span></span><span class="alectryon-token"> <span class="bp">=</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>0</var><b>: </b><span>Nat</span></span></div></blockquote></div></small></div><span class="mi">0</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">then</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>XPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>XPlayer</span><span class="alectryon-token"> </span><span class="alectryon-token"><span class="k">else</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>OPlayer</var><b>: </b><span>Player</span></span></div></blockquote></div></small></div>OPlayer</span><span class="alectryon-token">,
    generator := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gen'</var><b>: </b><span>StdGen</span></span></div></blockquote></div></small></div><span class="nv">gen&#39;</span></span><span class="alectryon-token"> }
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (_, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>g</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">g</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>playGame</var><b>: </b><span>StateM GameState PUnit</span></span></div></blockquote></div></small></div>playGame</span><span class="alectryon-token"> <span class="bp">|&gt;.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>run</var><b>: </b><span>{σ : Type} → {m : Type → Type} → {α : Type} → StateT σ m α → σ → m (α × σ)</span></span></div></blockquote></div></small></div>run</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>printBoard</var><b>: </b><span>{Board : Prop} → Board → IO Unit</span></span></div></blockquote></div></small></div>printBoard</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>g</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">g</span></span><span class="alectryon-token"><span class="bp">.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>board</var><b>: </b><span>GameState → ∀ {Board : Prop}, Board</span></span></div></blockquote></div></small></div>board</span><span class="alectryon-token">

</span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chka" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chka"><span class="alectryon-token"><span class="k">#eval</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>main</var><b>: </b><span>IO Unit</span></span></div></blockquote></div></small></div>main</span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Error: cannot evaluate code because <span class="bp">&#39;</span>_eval._lambda_1&#39; uses <span class="bp">&#39;</span><span class="gr">sorry</span><span class="bp">&#39;</span> and<span class="bp">/</span>or contains errors</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token">
<span class="c1">-- [X, X, O]</span>
<span class="c1">-- [X, O, O]</span>
<span class="c1">-- [O, O, X]</span></span></span></pre>
<p>Note that when you run the above code interactively the random number generator always starts in the
same place.  But if you run <code>lean --run states.lean</code> then you will see randomness in the result.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>It may be helpful to see how the <code>StateM</code> monad adds the input state and output state.  If you look
at the reduced Type for <code>nextTurn</code>:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-sentence"><input class="alectryon-toggle" id="states-lean-chkb" style="display: none" type="checkbox"><label class="alectryon-input" for="states-lean-chkb"><span class="alectryon-token"><span class="k">#reduce</span></span></label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">GameState <span class="bp">→</span> Bool <span class="bp">×</span> GameState</blockquote></div></div></small></span><span class="alectryon-wsp"><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StateM</var><b>: </b><span>Type → Type → Type</span></span></div></blockquote></div></small></div>StateM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Bool</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Bool</span><span class="alectryon-token">
<span class="c1">-- GameState → Bool × GameState</span></span></span></pre>
<p>So a function like <code>nextTurn</code> that might have just returned a <code>Bool</code> has been modified by the
<code>StateM</code> monad such that the initial <code>GameState</code> is passed in as a new input argument, and the output
value has been changed to the pair <code>Bool × GameState</code> so that it can return the pure <code>Bool</code> and the
updated <code>GameState</code>.  So <code>playGame</code> then is automatically saving that updated game state so that each
time around the <code>while</code> loop it is acting on the new state, otherwise that would be an infinite loop!</p>
<p>It is also interesting to see how much work the <code>do</code> and <code>←</code> notation are doing for you.  To
implement the <code>nextTurn</code> function without these you would have to write this, manually plumbing
the state all the way through:</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="alectryon-token"><span class="kd">def</span></span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>nextTurnManually</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div><span class="nv">nextTurnManually</span></span><span class="alectryon-token"> : </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>StateM</var><b>: </b><span>Type → Type → Type</span></span></div></blockquote></div></small></div>StateM</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>GameState</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>GameState</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>Bool</var><b>: </b><span>Type</span></span></div></blockquote></div></small></div>Bool</span><span class="alectryon-token">
<span class="bp">|</span> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>state</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">state</span></span><span class="alectryon-token"> <span class="bp">=&gt;</span>
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>chooseRandomMove</var><b>: </b><span>StateM GameState TileIndex</span></span></div></blockquote></div></small></div>chooseRandomMove</span><span class="alectryon-token"> <span class="bp">|&gt;.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>run</var><b>: </b><span>{σ : Type} → {m : Type → Type} → {α : Type} → StateT σ m α → σ → m (α × σ)</span></span></div></blockquote></div></small></div>run</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>state</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">state</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (_, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs'</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs&#39;</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>applyMove</var><b>: </b><span>TileIndex → StateM GameState Unit</span></span></div></blockquote></div></small></div>applyMove</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>i</var><b>: </b><span>TileIndex</span></span></div></blockquote></div></small></div><span class="nv">i</span></span><span class="alectryon-token">  <span class="bp">|&gt;.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>run</var><b>: </b><span>{σ : Type} → {m : Type → Type} → {α : Type} → StateT σ m α → σ → m (α × σ)</span></span></div></blockquote></div></small></div>run</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs</span></span><span class="alectryon-token">
  </span><span class="alectryon-token"><span class="k">let</span></span><span class="alectryon-token"> (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>result</var><b>: </b><span>Bool</span></span></div></blockquote></div></small></div><span class="nv">result</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs''</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs&#39;&#39;</span></span><span class="alectryon-token">) := </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>isGameDone</var><b>: </b><span>StateM GameState Bool</span></span></div></blockquote></div></small></div>isGameDone</span><span class="alectryon-token"> <span class="bp">|&gt;.</span></span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>run</var><b>: </b><span>{σ : Type} → {m : Type → Type} → {α : Type} → StateT σ m α → σ → m (α × σ)</span></span></div></blockquote></div></small></div>run</span><span class="alectryon-token"> </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs'</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs&#39;</span></span><span class="alectryon-token">
  (</span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>result</var><b>: </b><span>Bool</span></span></div></blockquote></div></small></div><span class="nv">result</span></span><span class="alectryon-token">, </span><span class="alectryon-token"><div class="alectryon-type-info-wrapper"><small class="alectryon-type-info"><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span class="hyp-type"><var>gs''</var><b>: </b><span>GameState</span></span></div></blockquote></div></small></div><span class="nv">gs&#39;&#39;</span></span><span class="alectryon-token">)</span></span></pre>
<p>This expression <code>let (i, gs)</code> conveniently breaks a returned pair up into 2 variables.
In the expression <code>let (_, gs')</code> we didn't care what the first value was so we used underscore.
Notice that nextTurn is capturing the updated game state from <code>chooseRandomMove</code> in the variable
<code>gs</code>, which it is then passing to <code>applyMove</code> which returns <code>gs'</code> which is passed to <code>isGameDone</code>
and that function returns <code>gs''</code> which we then return from <code>nextTurnManually</code>.  Phew, what a lot
of work you don't have to do when you use <code>do</code> notation!</p>
<h2 id="statem-vs-readerm"><a class="header" href="#statem-vs-readerm">StateM vs ReaderM</a></h2>
<p>While <code>ReaderM</code> functions can use <code>withReader</code> to modify the context before calling another function,
<code>StateM</code> functions are a little more powerful, let's look at this function again:</p>
<pre><code>def nextTurn : StateM GameState Bool := do
  let i ← chooseRandomMove
  applyMove i
  isGameDone
</code></pre>
<p>In this function <code>chooseRandomMove</code> is modifying the state that <code>applyMove</code> is getting
and <code>chooseRandomMove</code> knows nothing about <code>applyMove</code>.  So <code>StateM</code> functions can have this
kind of downstream effect outside their own scope, whereas, <code>withReader</code> cannot do that.</p>
<p>So there is no equivalent to <code>withReader</code> for <code>StateM</code>, besides you can always use the <code>StateM</code>
<code>set</code> function to modify the state before calling the next function anyway.  You could however,
manually call a <code>StateM</code> function like you see in <code>nextTurnManually</code> and completely override
the state at any point that way.</p>
<h2 id="state-io-and-other-languages"><a class="header" href="#state-io-and-other-languages">State, IO and other languages</a></h2>
<p>When thinking about Lean, it is often seen as a restriction that you can't have global variables or
<code>static</code> variables like you can with other languages like Python or C++. However, hopefully you see
now this isn't true. You can have a data type with exactly the same functionality as a Python class.
You would simply have many functions that can modify some global state using the <code>StateM</code> monad.</p>
<p>The difference is in Lean you simply put a label on these types of functions. You don't allow it to
happen for free anywhere in an uncontrolled fashion because that results in too many sleepless
nights debugging nasty code. You want to know when side effects can potentially happen, because
knowing when they can happen makes your code easier to reason about. In a Python class, many of the
methods won't actually need to modify the global state. But they could, which makes it harder to
debug them. In Lean you can simply make these pure functions, and the compiler will ensure they stay
pure and cannot modify any global state.</p>
<p>IO is the same way. It's not like you can't perform IO in Lean. Instead, you want to label the areas
where you can, to increase your certainty about the areas where you don't need to. When you know part of
your code cannot communicate with the outside world, you can be far more certain of its behavior.</p>
<p>The <code>StateM</code> monad is also a more disciplined way of managing side effects. Top level code could
call a <code>StateM</code> function multiple times with different independent initial states, even doing that
across multiple tasks in parallel and each of these cannot clobber the state belonging to other
tasks. Monadic code is more predictable and reusable than code that uses global variables.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>That wraps it up for the <code>StateM</code> monad! There is one more very useful monad that can be used to do
exception handling which will be covered in the <a href="except.lean.html">next section</a>.</p>
<pre class="alectryon-io type-info-hidden highlight"><!-- Generator: Alectryon --></pre>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../monads/readers.lean.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../monads/except.lean.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../monads/readers.lean.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../monads/except.lean.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../alectryon.js"></script>
    </body>
</html>
